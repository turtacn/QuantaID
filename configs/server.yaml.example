# QuantaID Server Configuration Example
# This file provides a comprehensive example of all available configuration options.
# Copy this file to 'server.yaml' and adjust the values to your needs.

# Server configuration
server:
  # Host address to bind to
  host: "0.0.0.0"
  # Port to listen on
  port: 8080
  # Graceful shutdown timeout in seconds
  shutdown_timeout: 10

# Logger configuration
logger:
  # Minimum log level (debug, info, warn, error)
  level: "info"
  # Log format (json or console)
  format: "json"
  console:
    # Enable console logging
    enabled: true
  file:
    # Enable file logging
    enabled: false
    # Log file path
    path: "/var/log/quantaid.log"
    # Max size in MB before rotation
    max_size_mb: 100
    # Max number of old log files to retain
    max_backups: 10
    # Max number of days to retain old log files
    max_age_days: 30
    # Compress rotated log files
    compress: true

# Policy engine configuration
policy:
  opa:
    # Enable OPA engine
    enabled: true
    # Mode: "sdk" (in-process) or "sidecar" (remote)
    mode: "sdk"
    # Path to the Rego policy file (for SDK mode)
    file_path: "internal/policy/rego/main.rego"
    # URL of the OPA server (for Sidecar mode)
    url: "http://localhost:8181/v1/data/quantaid/authz"

# Storage configuration
storage:
  # Storage mode can be "memory" or "postgres"
  mode: "postgres"

# PostgreSQL configuration for identity, policy, and audit storage
postgres:
  host: "localhost"
  port: 5432
  user: "quantaid"
  password: "quantaid-password"
  dbname: "quantaid_dev"
  sslmode: "disable" # Use "require" or "verify-full" in production
  # Connection pool settings
  max_idle_conns: 10
  max_open_conns: 100
  conn_max_lifetime: "1h"

# Redis configuration for session and token storage
redis:
  # Redis server host
  host: "localhost"
  # Redis server port
  port: 6379
  # Redis server password (leave empty if none)
  password: ""
  # Redis database to use
  db: 0
  # Connection pool size
  pool_size: 20
  # Dial timeout in seconds
  dial_timeout: 5
  # Minimum number of idle connections
  min_idle_conns: 5
  # Maximum age of a connection
  max_conn_age: "30m"
  # Amount of time to wait for a connection when the pool is full
  pool_timeout: "4s"
  # Amount of time after which an idle connection is closed
  idle_timeout: "5m"
  # Health check configuration for the connection pool
  health_check:
    # Enable periodic health checks
    enabled: true
    # Interval between health checks
    interval: "30s"
  # Retry configuration for establishing a connection
  retry:
    # Maximum number of retry attempts
    max_attempts: 3
    # Initial backoff duration for the first retry
    initial_backoff: "1s"
    # Maximum backoff duration between retries
    max_backoff: "10s"

# Session management configuration
session:
  # Default session TTL (Time-To-Live)
  default_ttl: "24h"
  # Enable session rotation to prevent session fixation attacks
  enable_rotation: true
  # How often a session ID should be rotated
  rotation_interval: "5m"
  # Bind sessions to a device fingerprint (User-Agent + IP)
  enable_device_binding: true
  # Maximum number of concurrent sessions per user (0 for unlimited)
  max_sessions_per_user: 5

# Audit log configuration
audit:
  # Number of days to retain audit logs (0 for forever)
  retention_days: 90
  # Buffer size for async audit logging
  buffer_size: 1000
  # Flush interval for async logging in milliseconds
  flush_interval_ms: 5000

# Webhook configuration
webhook:
  # Maximum number of retries for failed deliveries
  max_retries: 3

# Privacy settings
privacy:
  policy_versions:
    terms_of_service: "1.0.0"
    privacy_policy: "1.0.0"

# Observability configuration
observability:
  # Enable Prometheus metrics endpoint
  metrics_enabled: true
  # Port for the /metrics endpoint
  metrics_port: 9090
  # Enable OpenTelemetry tracing
  tracing_enabled: true
  # OTLP exporter endpoint (e.g., "jaeger:4317")
  otlp_endpoint: "stdout"

# Security configuration
security:
  # Adaptive risk engine configuration
  adaptive_risk:
    # Thresholds for risk levels
    thresholds:
      low: 0.3
      medium: 0.7
      high: 1.0
    # Weights for risk factors
    weights:
      ip_reputation: 0.5
      geo_reputation: 0.2
      device_change: 0.3
      geo_velocity: 0.1
      time_anomaly: 0.1
  # Response policies for the automator engine
  response_policies:
    - name: "Block High-Risk IP"
      risk_threshold: 0.9
      actions:
        - "block_ip"
      is_blocking: true
    - name: "Lock High-Risk User"
      risk_threshold: 0.9
      actions:
        - "lock_user"
      is_blocking: false # Don't block the login flow, just lock the user
    - name: "Kill High-Risk Session"
      risk_threshold: 0.8
      actions:
        - "kill_session"
      is_blocking: false
  # MFA policies configuration
  mfa_policies:
    # Require MFA for all logins
    require_mfa: false
    # List of enabled MFA providers
    enabled_providers:
      - "totp"
      - "webauthn"
  # Rate limiting configuration
  rate_limit:
    # Enable rate limiting
    enabled: true
    # Default rate limit (requests per window)
    default_limit: 1000
    # Default window size in seconds
    default_window: 60

# Sync configuration
sync:
  # Batch size for synchronization operations
  batch_size: 100
  # Strategy for resolving conflicts (RemoteWins, LocalWins, Merge)
  conflict_strategy: "RemoteWins"

# WebAuthn configuration
webauthn:
  # Relying Party ID (usually the domain name)
  rp_id: "localhost"
  # Relying Party Origin (scheme + host + port)
  origin: "http://localhost:8080"
  # Relying Party Display Name
  rp_display_name: "QuantaID"

# UI settings for user-facing pages (login, profile, etc.)
ui:
  # Base path for static assets (CSS, JS). Handled by Go's embed in this phase.
  static_path: "web/static"
  # Base path for HTML templates. Handled by Go's embed in this phase.
  template_path: "web/templates"

# Identity Lifecycle and Data Governance configuration
lifecycle:
  # Enable lifecycle job
  enabled: true
  # Run interval
  interval: "24h"
  # Batch size for user scanning
  batch_size: 100
  # Dry run mode (do not execute actions)
  dry_run: false
  # Lifecycle rules
  lifecycle_rules:
    - name: "Disable inactive users"
      description: "Disable users who haven't logged in for 90 days"
      conditions:
        - attribute: "lastLoginAt"
          operator: "gt"
          value: "2160h" # 90 days
      actions:
        - type: "disable"
    - name: "Delete expired users"
      description: "Delete users who expired"
      conditions:
        - attribute: "attributes.expiredAt"
          operator: "lt"
          value: "0s" # Now
      actions:
        - type: "delete"
  # Data governance configuration
  governance:
    required_fields:
      - "email"
      - "username"
